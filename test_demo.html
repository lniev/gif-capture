<button id="btn-start-recording">Start Recording</button>
<button id="btn-stop-recording" style="display: none;">Stop Recording</button>
<button id="select" onclick="startSelect()">select</button>

<style>
	#screenshotBox {
		border: 1px solid rebeccapurple;
	}
</style>
<br>
<hr>

<div id="edit-panel" style="border-bottom: 1px solid;">
	<div>
		<label for="x">X</label>
		<input type="number" name="x" id="x" value="0" />
	</div>
	<div>
		<label for="y">Y</label>
		<input type="number" name="y" id="y" value="0" />
	</div>
	<div>
		<label for="w">Width (-1 = Full size)</label>
		<input type="number" name="w" id="w" value="-1" />
	</div>
	<div>
		<label for="h">Height (-1 = Full size)</label>
		<input type="number" name="h" id="h" value="-1" />
	</div>
	<canvas></canvas>
</div>

<video id="mediaElement" autoplay playsinline></video>
<script src="./min.js"></script>
<img src="" alt="" id="img" height="240" width="320" />

<script>

	
	var CROP_X = 100;
	var CROP_Y = 200;
	var CROP_W = 420; // default width
	var CROP_H = 440; // default height
	var MAX_VIDEO_WIDTH = 1920;
	var MAX_VIDEO_HEIGHT = 1080;
	var _canvas;
	var _context;
	var htmlCanvasElement = document.querySelector('canvas');

	function startSelect() {
		function ejectMove(e) {
			const [startX, startY] = [e.clientX, e.clientY]
			const divEle = document.createElement('div')
			divEle.id = "screenshot"
			divEle.width = '1px'
			divEle.height = '1px'
			divEle.style.position = 'absolute'
			divEle.style.top = startY + 'px'
			divEle.style.left = startX + 'px'
			document.body.appendChild(divEle)
			// 
			const moveEvent = (e) => {
				console.log(333)

				const moveX = e.clientX - startX
				const moveY = e.clientY - startY
				divEle.style.width = Math.abs(moveX) + 'px'
				divEle.style.height = Math.abs(moveY) + 'px'
				if (moveX < 0) {
					divEle.left = e.clientX + 'px'
				}
				if (moveY < 0) {
					divEle.top = e.clientY + 'px'
				}
			}
			const [screenX, screenY] = [e.screenX, e.screenY]

			window.addEventListener('mousemove', moveEvent)
			window.addEventListener('mouseup', () => {
				CROP_X = screenX - 1920;
				CROP_Y = screenY;
				window.removeEventListener('mousemove', moveEvent)
				window.removeEventListener('mousedown', ejectMove)
			})
		}
		window.addEventListener('mousedown', ejectMove)
	}



	// Form elements
	// document.getElementById("x").value = CROP_X;
	// document.getElementById("y").value = CROP_Y;
	// document.getElementById("w").value = CROP_W;
	// document.getElementById("h").value = CROP_H;

	_context = htmlCanvasElement.getContext('2d');

	/**
	 * Crops a video frame and shows it to the user
	 */
	function CropFrame(ev, stream, video, callback) {
		callback = callback || function () { };

		_canvas = htmlCanvasElement;

		if (CROP_X < 0) {
			CROP_X = 0;
		}
		if (CROP_Y < 0) {
			CROP_Y = 0;
		}
		// if (CROP_W <= 0) {
		// 	CROP_W = VIDEO_WIDTH;
		// }
		// if (CROP_H <= 0) {
		// 	CROP_H = VIDEO_HEIGHT;
		// }
		if (CROP_W > MAX_VIDEO_WIDTH) {
			CROP_W = MAX_VIDEO_WIDTH;
		}
		if (CROP_H > MAX_VIDEO_HEIGHT) {
			CROP_W = MAX_VIDEO_HEIGHT;
		}

		_canvas.width = CROP_W;
		_canvas.height = CROP_H;

		_context.drawImage(video, CROP_X, CROP_Y, CROP_W, CROP_H, 0, 0, CROP_W, CROP_H);

		// We need to scale down the image or else we get HTTP 414 Errors
		// Also we scale down because of RTC message length restriction
		var scanvas = document.createElement('canvas');
		scanvas.width = _canvas.width;
		scanvas.height = _canvas.height;

		var wRatio = _canvas.width / 320;
		var hRatio = _canvas.height / 240;
		var maxRatio = Math.max(wRatio, hRatio);
		if (maxRatio > 1) {
			scanvas.width = _canvas.width / maxRatio;
			scanvas.height = _canvas.height / maxRatio;
		}
		scanvas.getContext('2d').drawImage(_canvas, 0, 0, scanvas.width, scanvas.height);

		callback(scanvas.toDataURL("image/jpeg"));
	}

	var recorder;

	function getScreenStream(callback) {
		if (navigator.getDisplayMedia) {
			navigator.getDisplayMedia({
				video: true
			}).then(screenStream => {
				callback(screenStream);
			});
		} else if (navigator.mediaDevices.getDisplayMedia) {
			navigator.mediaDevices.getDisplayMedia({
				video: true
			}).then(screenStream => {
				callback(screenStream);
			});
		} else {
			alert('getDisplayMedia API is not supported by this browser.');
		}
	}

	var mediaElement = document.querySelector('#mediaElement');

	//开始
	document.querySelector('#btn-start-recording').onclick = function () {
		const screenshotEle = document.getElementById('screenshot')
		if (!screenshotEle) return
		// CROP_X = screenshotEle.offsetLeft;
		// CROP_Y = screenshotEle.offsetTop;
		CROP_W = screenshotEle.clientWidth;
		CROP_H = screenshotEle.clientHeight;

		document.getElementById("x").value = CROP_X;
		document.getElementById("y").value = CROP_Y;
		document.getElementById("w").value = CROP_W;
		document.getElementById("h").value = CROP_H;

		document.querySelector('#btn-start-recording').style.display = 'none';

		getScreenStream(function (screen) {
			var inited = false;

			mediaElement.ontimeupdate = function (ev) {
				if (!inited) {
					VIDEO_WIDTH = mediaElement.offsetWidth;
					VIDEO_HEIGHT = mediaElement.offsetHeight;

					mediaElement.style.display = 'none';
					document.querySelector('#edit-panel').style.display = 'block';

					inited = true;
				}

				CropFrame(ev, screen, mediaElement);
			};

			mediaElement.srcObject = screen;
			mediaElement.screen = screen;

			// addStreamStopListener(screen, function () {
			// 	document.querySelector('#btn-stop-recording').onclick();
			// });

			// RecordRTC goes here
			var captureStream = htmlCanvasElement.captureStream();
			recorder = RecordRTC(captureStream, {
				// type: 'video'，
				type: 'gif',
				frameRate: 1,
				quality: 100,
				width: CROP_W,
				hidden: CROP_H,
				onGifRecordingStarted: function () {
				},
				onGifPreview: function (gifURL) {
					var image = document.getElementById('img')
					image.src = gifURL;
				}
			});
			recorder.startRecording();
			document.querySelector('#btn-stop-recording').style.display = 'inline';
		});
	};



	function stopRecordingCallback() {
		var image = document.getElementById('img')
		image.src = URL.createObjectURL(recorder.getBlob());
		recorder.destroy();
		recorder = null;
	}

	// 停止
	document.querySelector('#btn-stop-recording').onclick = function () {
		document.querySelector('#btn-stop-recording').style.display = 'none';

		recorder.stopRecording(function () {
			var blob = recorder.getBlob();

			document.querySelector('#edit-panel').style.display = 'none';
			mediaElement.style.display = 'block';

			mediaElement.srcObject = null;
			mediaElement.src = URL.createObjectURL(blob);

			if (mediaElement.screen && mediaElement.screen.getVideoTracks) {
				mediaElement.screen.stop();
				mediaElement.screen = null;
			}
			stopRecordingCallback()
			document.querySelector('#btn-start-recording').style.display = 'inline';
		});
	};

	// function addStreamStopListener(stream, callback) {
	// 	stream.addEventListener('ended', function () {
	// 		callback();
	// 		callback = function () { };
	// 	}, false);
	// 	stream.addEventListener('inactive', function () {
	// 		callback();
	// 		callback = function () { };
	// 	}, false);
	// 	stream.getTracks().forEach(function (track) {
	// 		track.addEventListener('ended', function () {
	// 			callback();
	// 			callback = function () { };
	// 		}, false);
	// 		track.addEventListener('inactive', function () {
	// 			callback();
	// 			callback = function () { };
	// 		}, false);
	// 	});
	// }
</script>